{% extends 'base2.html' %}
{% load static %}

{% block content %}
    <meta charset="utf-8">
    <title>贊助專案</title>

    <style type="text/css">
        @import url("{% static 'css/贊助專案css.css' %}");
    </style>
    <link href="{% static 'jQueryAssets/jquery.ui.core.min.css' %}" rel="stylesheet" type="text/css">
    <link href="{% static 'jQueryAssets/jquery.ui.theme.min.css' %}" rel="stylesheet" type="text/css">
    <link href="{% static 'jQueryAssets/jquery.ui.button.min.css' %}" rel="stylesheet" type="text/css">
    <link href="{% static 'css/bootstrap.css' %}" rel="stylesheet" type="text/css">
    <link href="{% static 'css/bootstrap-4.0.0.css.css' %}" rel="stylesheet" type="text/css">
    <script src="{% static 'jQueryAssets/jquery-1.11.1.min.js' %}" type="text/javascript"></script>
    <script src="{% static 'jQueryAssets/jquery.ui-1.10.4.button.min.js' %}" type="text/javascript"></script>
    <script src="{% static 'jQueryAssets/jquery.ui-1.10.4.tabs.min' %}" type="text/javascript"></script>
    <script src="{% static 'jQueryAssets/jquery.ui-1.10.4.slider.min' %}" type="text/javascript"></script>
    <script src="{% static 'js/bootstrap.js' %}" type="text/javascript"></script>
    <script src="{% static 'js/jquery-1.11.3.min.js' %}" type="text/javascript"></script>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>


    <body style="width: 100%;height:100%;">
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <div id="doublecheck">
        <ul>
            <ul>
                <li id="doublecheck-item">專題名稱:{{ project.project_name }}</li>
                <li id="doublecheck-money">總共:{{ feedback.feedback_money }}</li>
                <li id="doublecheck-description">專題內容:{{ feedback.feedback_description }}</li>
                <li id="doublecheck-contractaddr">contractaddr:</li>
                <li>使用者address:0x<input type="text" name="userccontractaddr" id='userccontractaddr-id'></li>
            </ul>
        </ul>
        <button type="button" class="btn btn-success" onclick="createExampleContract();">確定</button>
        <button type="button" class="btn btn-danger" id="cancel">取消</button>

    </div>
    <div style="clear: both;"></div>
    </div>
    <script>
        if (typeof web3 !== 'undefined') {
            web3 = new Web3(web3.currentProvider);
        } else {
            // set the provider you want from Web3.providers
            //web3 = new Web3(new Web3.providers.H
            // web3 = new Web3(new Web3.providers.HttpProvider("https://ropsten.infura.io/v3/866424fc5e1643f0837915f33cdb8565"));
            web3 = new Web3(new Web3.providers.HttpProvider('http://localhost:7545'));
        }

        const contractABI = [{
            "constant": true,
            "inputs": [],
            "name": "startDate",
            "outputs": [{"name": "", "type": "uint256"}],
            "payable": false,
            "stateMutability": "view",
            "type": "function"
        }, {
            "constant": true,
            "inputs": [],
            "name": "refunded",
            "outputs": [{"name": "", "type": "bool"}],
            "payable": false,
            "stateMutability": "view",
            "type": "function"
        }, {
            "constant": true,
            "inputs": [],
            "name": "getPot",
            "outputs": [{"name": "", "type": "uint256"}],
            "payable": false,
            "stateMutability": "view",
            "type": "function"
        }, {
            "constant": true,
            "inputs": [],
            "name": "complete",
            "outputs": [{"name": "", "type": "bool"}],
            "payable": false,
            "stateMutability": "view",
            "type": "function"
        }, {
            "constant": false,
            "inputs": [],
            "name": "refund",
            "outputs": [],
            "payable": false,
            "stateMutability": "nonpayable",
            "type": "function"
        }, {
            "constant": false,
            "inputs": [{"name": "_message", "type": "bytes32"}],
            "name": "pledge",
            "outputs": [],
            "payable": true,
            "stateMutability": "payable",
            "type": "function"
        }, {
            "constant": true,
            "inputs": [],
            "name": "benefactor",
            "outputs": [{"name": "", "type": "address"}],
            "payable": false,
            "stateMutability": "view",
            "type": "function"
        }, {
            "constant": true,
            "inputs": [],
            "name": "owner",
            "outputs": [{"name": "", "type": "address"}],
            "payable": false,
            "stateMutability": "view",
            "type": "function"
        }, {
            "constant": true,
            "inputs": [],
            "name": "targetAmount",
            "outputs": [{"name": "", "type": "uint256"}],
            "payable": false,
            "stateMutability": "view",
            "type": "function"
        }, {
            "constant": true,
            "inputs": [],
            "name": "numPledges",
            "outputs": [{"name": "", "type": "uint256"}],
            "payable": false,
            "stateMutability": "view",
            "type": "function"
        }, {
            "constant": true,
            "inputs": [{"name": "", "type": "uint256"}],
            "name": "pledges",
            "outputs": [{"name": "amount", "type": "uint256"}, {
                "name": "eth_address",
                "type": "address"
            }, {"name": "message", "type": "bytes32"}],
            "payable": false,
            "stateMutability": "view",
            "type": "function"
        }, {
            "constant": false,
            "inputs": [],
            "name": "drawdown",
            "outputs": [],
            "payable": false,
            "stateMutability": "nonpayable",
            "type": "function"
        }, {
            "constant": true,
            "inputs": [],
            "name": "PayByCash",
            "outputs": [{"name": "", "type": "bool"}],
            "payable": false,
            "stateMutability": "view",
            "type": "function"
        }, {
            "inputs": [{"name": "_benefactor", "type": "address"}, {"name": "_targetAmount", "type": "uint256"}],
            "payable": false,
            "stateMutability": "nonpayable",
            "type": "constructor"
        }]


        //const account1 = '0xae520E39536a0b01b449c0d258b73B68d2762fB0'
        //const account2 = '0x6FB6B00b9b2540C53c08F71a29CC13F85B20bD4e'
        const account3 = '0x84b1b837391C66e40B7a17201E8CF63fd55678DB'
        const account4 = '0x5071522A4556be001Cd97dA81bb35B2CD7D1d92F'

        var txHash
        const contractAddr = '0x9E1Df5C7383016EA6D8AD9A0CF7464330bFA5A3f'
        const sendMsg = 'Item:2, two single pen'

        const pledgeAmount = '10'
        const pledgeUnit = 'ether'
        const pledgeAccount = account3

        function createExampleContract() {

            const smartsponsorContract = new web3.eth.Contract(contractABI, contractAddr)

            smartsponsorContract.methods.pledge(web3.utils.fromAscii(sendMsg)).send({
                from: pledgeAccount,
                value: web3.utils.toHex(web3.utils.toWei(pledgeAmount, pledgeUnit)),
                gasLimit: web3.utils.toHex(1000000),    //Raise this
                gasPrice: web3.utils.toHex(web3.utils.toWei('10', 'gwei'))
            })
                .on('transactionHash', function (transactionHash) {
                    // console.log("deploy transaction hash: ", transactionHash);
                    txHash = transactionHash;                       // store the value of transactionHash to Django's Database , under Table PROJECT.transactionHash
                    document.write("txHash: " + txHash);
                })
                .then(async function (myContactInstance) {
                    document.write("deployed successfully.")
                    document.write("now the addr %o balance is %o", pledgeAccount, (web3.utils.fromWei(await web3.eth.getBalance(pledgeAccount), 'ether')))

                })
                .catch(err => {
                    document.write("Error: failed to deploy, detail:", err)
                })


        }

    </script>
    </body>
{% endblock %}